name: Watch Organization Custom Role Permissions

on:
  schedule:
    - cron: '0 0 1 * *'  # Run on the 1st of each month at 00:00 UTC
  workflow_dispatch:
    inputs:
      create_sample_pr:
        description: 'Create a sample pull request to verify pull request creation works correctly'
        type: boolean
        default: false

jobs:
  watch-permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ secrets.ORGANIZATION_NAME }}

      - name: Fetch organization fine-grained permissions
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORGANIZATION_NAME: ${{ secrets.ORGANIZATION_NAME }}
          CREATE_SAMPLE_PR: ${{ inputs.create_sample_pr }}
        run: |
          mkdir -p data
          if [ "$CREATE_SAMPLE_PR" = "true" ]; then
            jq -n '[
              {"description":"View organization roles","name":"read_organization_custom_org_role"},
              {"description":"Manage custom organization roles","name":"write_organization_custom_org_role"}
            ]' | jq -S '.' > data/org-custom-role-permissions.json
          else
            gh api \
              --method GET \
              --header "Accept: application/vnd.github+json" \
              --header "X-GitHub-Api-Version: 2022-11-28" \
              --paginate \
              "/orgs/$ORGANIZATION_NAME/organization-fine-grained-permissions" \
              | jq -S '.' > data/org-custom-role-permissions.json
          fi

      - name: Check for changes
        id: changes
        run: |
          git add data/org-custom-role-permissions.json
          if git diff --cached --exit-code -- data/org-custom-role-permissions.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            git diff --cached -- data/org-custom-role-permissions.json > /tmp/permissions-diff.txt
          fi

      - name: Commit and push to a new branch
        if: steps.changes.outputs.changed == 'true' && inputs.create_sample_pr != true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH_NAME="update/org-custom-role-permissions-$(date +'%Y%m%d%H%M%S')"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_ENV"
          git checkout -b "$BRANCH_NAME"
          git commit -m "Update organization custom role permissions data"
          git push origin "$BRANCH_NAME"

      - name: Create pull request for permission changes
        if: steps.changes.outputs.changed == 'true' && inputs.create_sample_pr != true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          {
            echo "The available permissions for custom organization roles have been updated. Please review the differences."
            echo ""
            echo '```diff'
            cat /tmp/permissions-diff.txt
            echo '```'
          } > /tmp/pr-body.md

          if [ "${{ inputs.create_sample_pr }}" = "true" ]; then
            PR_TITLE="[Sample] Organization custom role permissions have been updated"
          else
            PR_TITLE="Organization custom role permissions have been updated"
          fi

          gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/pr-body.md \
            --base "${{ github.event.repository.default_branch }}" \
            --head "$branch_name"
