name: Watch Organization Custom Role Permissions

on:
  schedule:
    - cron: '0 0 1 * *'  # Run on the 1st of each month at 00:00 UTC
  workflow_dispatch:

jobs:
  watch-permissions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ secrets.ORGANIZATION_NAME }}

      - name: Fetch organization fine-grained permissions
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORGANIZATION_NAME: ${{ secrets.ORGANIZATION_NAME }}
        run: |
          mkdir -p data
          gh api \
            --method GET \
            --header "Accept: application/vnd.github+json" \
            --header "X-GitHub-Api-Version: 2022-11-28" \
            --paginate \
            "/orgs/$ORGANIZATION_NAME/organization-fine-grained-permissions" \
            > data/org-custom-role-permissions.json

      - name: Check for changes
        id: changes
        run: |
          git add data/org-custom-role-permissions.json
          if git diff --cached --exit-code -- data/org-custom-role-permissions.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            git diff --cached -- data/org-custom-role-permissions.json > /tmp/permissions-diff.txt
          fi

      - name: Commit and push updated permissions data
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update organization custom role permissions data"
          git push

      - name: Create issue for permission changes
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          {
            echo "The available permissions for custom organization roles have been updated. Please review the differences."
            echo ""
            echo '```diff'
            cat /tmp/permissions-diff.txt
            echo '```'
          } > /tmp/issue-body.md

          gh issue create \
            --title "Organization custom role permissions have been updated" \
            --body-file /tmp/issue-body.md
